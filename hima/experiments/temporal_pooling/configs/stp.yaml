_type_: stp.synthetic_sequences
project: stp.fast_weights
log: True    # wandb logging, use 'dry' for dummy do-nothing logging to test metrics collection

seed: 42
iterate:
  epochs: 8
  sequences: 5
  elements: 20

data:
  _base_: $_base.dataset.synthetic_sequences.general
  alphabet_size: 200
  encoder:
    _base_: $_base.encoder.random.fixed_sds
    sds: [500, 10]

model:
  api_block: ___
  pipeline:
    - ___.input -> gen.output
    - ???.output -> tm1.feedforward
    - tm1.predict
#    - tm1.predicted_cells -> sp1.feedforward
#    - repeat: 3
#      pipeline:
#        - sp1.compute
#        - sp1.output -> feedforward
    - tm1.predicted_cells -> concat.feedforward_1
    - tm1.predicted_cells -> concat.feedforward_2
    - repeat: 3
      pipeline:
        - concat.compute
        - concat.output -> sp1.feedforward
        - sp1.compute
        - sp1.output -> concat.feedforward_2
    - sp1.output -> tm1.predicted_cells
    - tm1.set_predicted_cells
    - tm1.activate
    - ???.active_cells -> ___.output

blocks:
  ___:
    _type_: block.storage
    input_sds: ???
    output_sds: ???
  gen:
    _type_: block.storage
  concat:
    _type_: block.concatenator
  sp1:
    _base_: custom_sp.default
    sp_type: vectorized
    output_sds: ??? #[500, 10]
    initial_rf_sparsity: 0.2
    max_rf_sparsity: 0.1
    max_rf_to_input_ratio: 0.5
#    learning_rate_inc: 0.1
    learning_rate_inc: 0.02
#    learning_rate_dec: 0.01
    learning_rate_dec: 0.005
    newborn_pruning_cycle: 5
    newborn_pruning_stages: 3
    boosting_k: 2.0
  tm1:
    _base_: tm.default_general_feedback
    seed: ???
    cells_per_column: 12
    activation_threshold_basal: .85
    learning_threshold_basal: .5
    activation_threshold_apical: 1
    learning_threshold_apical: 1
    max_synapses_per_segment_basal: 1.2
    max_segments_per_cell_basal: 32

stats_and_metrics:
  mae_normalization: no
  symmetrical_similarity: False
  distribution_metrics: pmf
  online_similarity_decay: 1.
  pmf_decay: 1.
  loss_normalization: False
  loss_layer_discount: 0.75

track_streams:
  gen.output:
    - sdr
    - cross.online.el
  sp1.output:
    - sdr
    - cross.online.el
  tm1.active_cells:
    - sdr
    - cross.online.el

diff_stats:
  online_el:
    - gen.output/epoch/sim_mx_on_el
    - sp1.output/epoch/sim_mx_on_el
    - tm1.active_cells/epoch/sim_mx_on_el

log_schedule:
  epoch: 2
  repeat: 3

iterate_setups:
  simple: ...

tm:
  default_general_feedback:
    _type_: tm.general_feedback

custom_sp:
  default:
    _type_: sp.custom
    seed: ???
    # input
    feedforward_sds: ???
    initial_rf_sparsity: 0.3
    max_rf_sparsity: 0.1
    max_rf_to_input_ratio: 2.5
    # output
    output_sds: ???
    # learning
    min_overlap_for_activation: 3
    learning_rate_inc: 0.1
    learning_rate_dec: 0.01
